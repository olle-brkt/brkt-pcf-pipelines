groups: []
resources:
- name: pcf-pipelines
  type: git
  source:
    branch: master
    private_key: {{git_private_key}}
    uri: git@github.com:pivotal-cf/pcf-pipelines.git
- name: brkt-pcf-pipelines
  type: git
  source:
    branch: master
    private_key: {{git_private_key}}
    uri: git@github.com:olle-brkt/brkt-pcf-pipelines.git
- name: patched-pipeline
  type: s3
  source:
    access_key_id: {{pipeline_params.aws_access_key_id}}
    bucket: {{pipeline_params.patched_pipeline_s3_bucket}}
    disable_ssl: false
    endpoint: {{S3_ENDPOINT}}
    region_name: {{aws_region}}
    secret_access_key: {{aws_secret_access_key}}
    versioned_file: pipeline.yml
resource_types: []
jobs:
- name: create-initial-state
  plan:
  - aggregate:
    - get: brkt-pcf-pipelines
  - task: create-initial-state
    file: brkt-pcf-pipelines/tasks/create-initial-state/task.yml
    params:
      AWS_ACCESS_KEY_ID: {{aws_access_key_id}}
      AWS_SECRET_ACCESS_KEY: {{aws_secret_access_key}}
      S3_BUCKET_TERRAFORM: {{S3_OUTPUT_BUCKET}}
      S3_BUCKET_PATCHED_PIPELINE: {{PATCHED_PIPELINE_S3_OUTPUT_BUCKET}}
      S3_BUCKET_ENCRYPTED_AMIS: {{ENCRYPTED_AMIS_S3_OUTPUT_BUCKET}}
      S3_ENDPOINT: {{S3_ENDPOINT}}
      S3_REGION: {{aws_region}}
- name: patch-pipeline
  plan:
  - aggregate:
    - get: pcf-pipelines
    - get: brkt-pcf-pipelines
    - get: patched-pipeline
  - task: patch-pipeline
    file: brkt-pcf-pipelines/tasks/patch-pipeline/task.yml
    params:
      ATC_EXTERNAL_URL: {{concourse_url}}
  - put: patched-pipeline
    params:
      file: generated-pipeline/pipeline.yml
- name: set-pipeline
  plan:
  - aggregate:
    - get: pcf-pipelines
    - get: brkt-pcf-pipelines
    - get: patched-pipeline
      passed:
      - patch-pipeline
      trigger: true
  - task: set-pipeline
    file: brkt-pcf-pipelines/tasks/set-pipeline/task.yml
    params:
      PEM: {{PEM}}
      git_private_key: {{git_private_key}}
      pipeline_name: {{pipeline_name}}
      concourse_url: {{concourse_url}}
      basic_auth_username: {{basic_auth_username}}
      basic_auth_password: {{basic_auth_password}}
      team_name: {{team_name}}
      patched_pipeline_s3_bucket: {{patched_pipeline_s3_bucket}}
      pipeline_params: {{pipeline_params}}